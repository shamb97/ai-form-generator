<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Widget Test</title>
    <style>
        .phase-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .phase-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .phase-tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .phase-tab.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        .phase-tab.completed {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .phase-tab.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .phase-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="phase-container">
        <h2>Phase Manager - Live Test</h2>
        
        <div class="phase-tabs" id="phaseTabs">
            <!-- Phases will be loaded here -->
        </div>
        
        <div class="phase-info" id="phaseInfo">
            <!-- Phase details will be shown here -->
        </div>
        
        <div>
            <button onclick="testPhaseAPI()">Test Phase API</button>
            <button onclick="loadTestPhases()">Load Test Phases</button>
        </div>
        
        <div id="debugOutput" style="margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px;">
            <h3>Debug Output:</h3>
            <pre id="debugText">Waiting for API call...</pre>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000';
        
        // Current phase data
        let currentPhases = [];
        let activePhase = null;
        
        // Test the Phase API
        async function testPhaseAPI() {
            const debugEl = document.getElementById('debugText');
            debugEl.textContent = 'Testing Phase API connection...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/health`);
                const data = await response.json();
                debugEl.textContent = `‚úÖ Backend is running!\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                debugEl.textContent = `‚ùå Error: ${error.message}\n\nMake sure backend is running on port 8000!`;
            }
        }
        
        // Load test phases
        async function loadTestPhases() {
            const debugEl = document.getElementById('debugText');
            debugEl.textContent = 'Loading test phases...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/test/phases`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                currentPhases = data.phases || [];
                activePhase = data.current_phase;
                
                debugEl.textContent = `‚úÖ Loaded ${currentPhases.length} phases!\n${JSON.stringify(data, null, 2)}`;
                
                // Render the phases
                renderPhases();
            } catch (error) {
                debugEl.textContent = `‚ùå Error loading test phases: ${error.message}`;
            }
        }
        
        // Render phases in the UI
        function renderPhases() {
            const tabsContainer = document.getElementById('phaseTabs');
            const infoContainer = document.getElementById('phaseInfo');
            
            if (currentPhases.length === 0) {
                tabsContainer.innerHTML = '<p>No phases loaded. Click "Load Test Phases".</p>';
                return;
            }
            
            // Create phase tabs
            tabsContainer.innerHTML = currentPhases.map(phase => {
                const isActive = phase.phase_id === activePhase;
                const classes = ['phase-tab'];
                
                if (isActive) classes.push('active');
                if (phase.completed) classes.push('completed');
                if (!phase.unlocked) classes.push('locked');
                
                return `
                    <div class="${classes.join(' ')}" onclick="selectPhase('${phase.phase_id}')">
                        <div>${phase.phase_name}</div>
                        <small>${phase.forms_completed || 0}/${phase.total_forms || 0} forms</small>
                    </div>
                `;
            }).join('');
            
            // Show active phase info
            const activePhaseData = currentPhases.find(p => p.phase_id === activePhase) || currentPhases[0];
            showPhaseInfo(activePhaseData);
        }
        
        // Show phase information
        function showPhaseInfo(phase) {
            const infoContainer = document.getElementById('phaseInfo');
            
            const completionPercent = phase.total_forms > 0 
                ? Math.round((phase.forms_completed / phase.total_forms) * 100)
                : 0;
            
            infoContainer.innerHTML = `
                <h3>${phase.phase_name}</h3>
                <p>${phase.description || 'No description available'}</p>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${completionPercent}%">
                        ${completionPercent}%
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <strong>Status:</strong> 
                    ${phase.completed ? '‚úÖ Complete' : phase.unlocked ? 'üîì In Progress' : 'üîí Locked'}
                </div>
                
                <div style="margin-top: 10px;">
                    <strong>Forms:</strong> ${phase.forms_completed || 0} of ${phase.total_forms || 0} completed
                </div>
            `;
        }
        
        // Select a phase
        function selectPhase(phaseId) {
            activePhase = phaseId;
            renderPhases();
        }
        
        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testPhaseAPI();
            }, 500);
        });
    </script>
</body>
</html>